<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê¥æËΩ¶Ë°®ÁÆ°ÁêÜÁ≥ªÁªü</title>
    
    <!-- ÈîôËØØÊçïËé∑ËÑöÊú¨ÔºöÂ¶ÇÊûúÈ°µÈù¢ÁôΩÂ±èÔºå‰ºöÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('loading-text').style.display = 'none';
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-message').innerText = 
                'Âä†ËΩΩÂá∫Èîô: ' + message + '\nÊù•Ê∫ê: ' + source + '\nË°åÂè∑: ' + lineno;
        };
    </script>

    <!-- 1. Âä†ËΩΩ React Âü∫Á°ÄÂ∫ì (Êú¨Âú∞Âåñ) -->
    <script crossorigin src="./lib/react.production.min.js"></script>
    <script crossorigin src="./lib/react-dom.production.min.js"></script>
    
    <!-- 2. Âä†ËΩΩ Babel (Êú¨Âú∞Âåñ) -->
    <script src="./lib/babel.min.js"></script>
    
    <!-- 3. Âä†ËΩΩ Dayjs (Êú¨Âú∞Âåñ) -->
    <script src="./lib/dayjs.min.js"></script>
    
    <!-- 4. Âä†ËΩΩ Ant Design (Êú¨Âú∞Âåñ) -->
    <script src="./lib/antd.min.js"></script>
    <script src="./lib/ant-design-icons.min.js"></script>
    
    <!-- 5. Âä†ËΩΩ SheetJS (ExcelÂØºÂá∫) -->
    <script src="https://cdn.staticfile.org/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { 
            padding: 20px; 
            background: linear-gradient(135deg, #f0f2f5 0%, #e6f7ff 100%); /* ÊüîÂíåÁöÑÊ∏êÂèòËÉåÊôØ */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); /* ËΩªÂæÆÈÄèÊòé */
            backdrop-filter: blur(10px);
            padding: 32px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            min-height: 500px; 
            border: 1px solid rgba(255,255,255,0.5);
        }
        #error-display { display: none; color: red; padding: 20px; background: #fff0f0; border: 1px solid red; margin: 20px; border-radius: 8px; }
        .loading-container { text-align: center; padding: 50px; }
        .loading-spinner { font-size: 24px; color: #1890ff; margin-bottom: 10px; }
        
        /* Â¢ûÂä†‰∏Ä‰∫õÂÖ®Â±ÄÊ†∑Âºè‰ºòÂåñ */
        .ant-btn-primary { box-shadow: 0 4px 10px rgba(24, 144, 255, 0.3); }
        .ant-card { border-radius: 12px !important; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .section-title { color: #1f2937; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        
        /* ÊâìÂç∞‰∏ìÁî®Ê†∑Âºè */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
            html, body {
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            /* ÈöêËóèÈô§ print-root Â§ñÁöÑÊâÄÊúâÂÖÉÁ¥† */
            body > *:not(#print-root) {
                display: none !important;
            }
            #print-root {
                display: block !important;
                position: relative;
                width: 100%;
                background: white;
            }
            /* Âº∫Âà∂ÊâìÂç∞ËÉåÊôØËâ≤ */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        #print-root { display: none; }
    </style>
</head>
<body>
    <div id="error-display">
        <h3>Á®ãÂ∫èÂêØÂä®ÂèëÁîüÈîôËØØ</h3>
        <pre id="error-message"></pre>
        <p>Âª∫ËÆÆÂ∞ùËØïÔºö1. Âà∑Êñ∞È°µÈù¢ 2. Ê£ÄÊü•ÁΩëÁªúËøûÊé• 3. Á°Æ‰øù‰ΩøÁî® Chrome/Edge ÊµèËßàÂô®</p>
    </div>

    <div id="root">
        <div class="loading-container">
            <div id="loading-text">
                <div class="loading-spinner">‚óè</div>
                <h3>Á≥ªÁªüÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂÄô...</h3>
                <p>È¶ñÊ¨°Âä†ËΩΩÂèØËÉΩÈúÄË¶ÅÂá†ÁßíÈíü‰∏ãËΩΩÁªÑ‰ª∂Â∫ì</p>
            </div>
        </div>
    </div>
    
    <!-- ÊâìÂç∞ÊåÇËΩΩÁÇπ -->
    <div id="print-root"></div>

    <script type="text/babel">
        // Á°Æ‰øù React Âíå Antd Â∑≤Âä†ËΩΩ
        if (!window.React || !window.antd) {
            throw new Error("React Êàñ Ant Design Â∫ìÊú™ËÉΩÊàêÂäüÂä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú„ÄÇ");
        }

        const { useState, useEffect, useMemo } = React;
        const { 
            Button, Table, Modal, Form, Input, InputNumber, 
            Select, Tabs, Card, Space, message, Popconfirm, 
            Typography, List, Descriptions, Divider, Tag, Empty,
            ConfigProvider, DatePicker, AutoComplete
        } = antd;
        const { Title, Text } = Typography;

        // --- ÊâìÂç∞Ê®°ÁâàÁªÑ‰ª∂ ---
        const DispatchSheetPrint = ({ data, addresses }) => {
            if (!data) return null;

            const getAddr = (id) => addresses.find(a => a.id === id) || {};

            return (
                <div style={{ padding: '40px', fontFamily: '"Microsoft YaHei", "SimHei", sans-serif', color: '#000', fontSize: '14px', lineHeight: '1.5' }}>
                    
                    {/* Header */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', borderBottom: '3px solid #000', paddingBottom: '20px', marginBottom: '30px' }}>
                        <div style={{ backgroundColor: '#000', padding: '10px 20px', display: 'flex', alignItems: 'center' }}>
                            <img 
                                src="https://www.oiaglobal.com/wp-content/themes/oiaglobal/images/OIA-Global.svg" 
                                alt="OIA Global" 
                                style={{ height: '50px', display: 'block' }} 
                            />
                        </div>
                        <div>
                            <h1 style={{ fontSize: '42px', fontWeight: '900', letterSpacing: '8px', margin: 0, lineHeight: 1 }}>Ê¥æËΩ¶Âçï</h1>
                        </div>
                    </div>

                    {/* Basic Info Grid */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '25px', marginBottom: '30px' }}>
                        <div style={{ borderBottom: '1px solid #ccc', paddingBottom: '5px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>Shipment ID</div>
                            <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{data.shipmentId || '-'}</div>
                        </div>
                        <div style={{ borderBottom: '1px solid #ccc', paddingBottom: '5px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>PO Âè∑Á†Å</div>
                            <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{data.poNumber || '-'}</div>
                        </div>
                        <div style={{ borderBottom: '1px solid #ccc', paddingBottom: '5px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>ÊâøËøêËΩ¶Èòü</div>
                            <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{data.fleet || '-'}</div>
                        </div>
                        <div style={{ borderBottom: '1px solid #ccc', paddingBottom: '5px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>ËΩ¶Âûã</div>
                            <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{data.vehicleType || '-'}</div>
                        </div>
                        <div style={{ borderBottom: '1px solid #ccc', paddingBottom: '5px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>ÊèêË¥ßÊó•Êúü</div>
                            <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{data.pickupDate ? dayjs(data.pickupDate).format('YYYY-MM-DD') : '-'}</div>
                        </div>
                        <div style={{ borderBottom: '1px solid #ccc', paddingBottom: '5px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '4px' }}>ÈÄÅË¥ßÊó•Êúü</div>
                            <div style={{ fontSize: '16px', fontWeight: 'bold' }}>{data.deliveryDate ? dayjs(data.deliveryDate).format('YYYY-MM-DD') : '-'}</div>
                        </div>
                    </div>

                    {/* Stops Section */}
                    <div style={{ marginBottom: '30px' }}>
                        <div style={{ backgroundColor: '#f5f5f5', color: '#000', padding: '8px 15px', fontWeight: 'bold', fontSize: '16px', marginBottom: '0', display: 'flex', alignItems: 'center', borderTop: '1px solid #000', borderLeft: '1px solid #000', borderRight: '1px solid #000' }}>
                            <span style={{ marginRight: '10px' }}>üìç</span> Ë∑ØÁ∫øËØ¶ÊÉÖ
                        </div>
                        <table style={{ width: '100%', borderCollapse: 'collapse', border: '1px solid #000' }}>
                            <thead>
                                <tr style={{ backgroundColor: '#fff', borderBottom: '2px solid #000' }}>
                                    <th style={{ padding: '12px', textAlign: 'center', width: '50px', borderRight: '1px solid #ddd', fontWeight: 'bold' }}>Â∫èÂè∑</th>
                                    <th style={{ padding: '12px', textAlign: 'left', borderRight: '1px solid #ddd', fontWeight: 'bold' }}>Âú∞ÂùÄ‰ø°ÊÅØ</th>
                                    <th style={{ padding: '12px', textAlign: 'left', width: '200px', fontWeight: 'bold' }}>ËÅîÁ≥ªÊñπÂºè</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.stops && data.stops.map((stop, index) => {
                                    const addr = getAddr(stop.addressId);
                                    return (
                                        <tr key={index} style={{ borderBottom: '1px solid #ddd' }}>
                                            <td style={{ padding: '12px', textAlign: 'center', borderRight: '1px solid #ddd', fontWeight: 'bold' }}>{index + 1}</td>
                                            <td style={{ padding: '12px', borderRight: '1px solid #ddd' }}>
                                                <div style={{ fontSize: '15px', fontWeight: 'bold', marginBottom: '4px' }}>{addr.name}</div>
                                                <div style={{ fontSize: '13px', color: '#444' }}>{addr.location}</div>
                                            </td>
                                            <td style={{ padding: '12px' }}>
                                                <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '2px' }}>{addr.contactPerson}</div>
                                                <div style={{ fontSize: '13px' }}>{addr.contactInfo}</div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {/* Cargo Section */}
                    <div style={{ marginBottom: '30px' }}>
                        <div style={{ backgroundColor: '#f5f5f5', color: '#000', padding: '8px 15px', fontWeight: 'bold', fontSize: '16px', marginBottom: '0', display: 'flex', alignItems: 'center', borderTop: '1px solid #000', borderLeft: '1px solid #000', borderRight: '1px solid #000' }}>
                            <span style={{ marginRight: '10px' }}>üì¶</span> Ë¥ßÁâ©‰ø°ÊÅØ
                        </div>
                        <table style={{ width: '100%', borderCollapse: 'collapse', border: '1px solid #000' }}>
                            <thead>
                                <tr style={{ backgroundColor: '#fff', borderBottom: '2px solid #000' }}>
                                    <th style={{ padding: '10px', textAlign: 'left', borderRight: '1px solid #ddd' }}>Ë¥ßÁâ©ÊèèËø∞</th>
                                    <th style={{ padding: '10px', textAlign: 'center', width: '100px', borderRight: '1px solid #ddd' }}>‰ª∂Êï∞</th>
                                    <th style={{ padding: '10px', textAlign: 'center', width: '100px', borderRight: '1px solid #ddd' }}>‰ΩìÁßØ (CBM)</th>
                                    <th style={{ padding: '10px', textAlign: 'center', width: '100px' }}>ÈáçÈáè (KG)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style={{ padding: '15px', borderRight: '1px solid #ddd', fontSize: '15px' }}>{data.cargoDescription || '-'}</td>
                                    <td style={{ padding: '15px', textAlign: 'center', borderRight: '1px solid #ddd', fontWeight: 'bold', fontSize: '16px' }}>{data.cargoCount || '-'}</td>
                                    <td style={{ padding: '15px', textAlign: 'center', borderRight: '1px solid #ddd', fontWeight: 'bold', fontSize: '16px' }}>{data.cargoCbm || '-'}</td>
                                    <td style={{ padding: '15px', textAlign: 'center', fontWeight: 'bold', fontSize: '16px' }}>{data.cargoWeight || '-'}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    {/* Notes Section */}
                    <div>
                        <div style={{ backgroundColor: '#f5f5f5', color: '#000', padding: '8px 15px', fontWeight: 'bold', fontSize: '16px', marginBottom: '0', display: 'flex', alignItems: 'center', border: '1px solid #000', borderBottom: 'none' }}>
                            <span style={{ marginRight: '10px' }}>üìù</span> Â§áÊ≥®‰ø°ÊÅØ
                        </div>
                        <div style={{ border: '1px solid #000', borderTop: '1px solid #000', padding: '15px', minHeight: '100px', whiteSpace: 'pre-wrap', fontSize: '14px', lineHeight: '1.6', backgroundColor: '#fff' }}>
                            {data.note || 'Êó†'}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Êï∞ÊçÆÂ≠òÂÇ®Â±Ç (LocalStorage) ---
        const DB_KEYS = {
            ADDRESSES: 'dispatch_addresses',
            ROUTES: 'dispatch_routes',
            ORDERS: 'dispatch_orders',
            FLEETS: 'dispatch_fleets'
        };

        const getAddresses = () => {
            try {
                return JSON.parse(localStorage.getItem(DB_KEYS.ADDRESSES) || '[]');
            } catch (e) { return []; }
        };
        const saveAddresses = (data) => localStorage.setItem(DB_KEYS.ADDRESSES, JSON.stringify(data));

        const getFleets = () => {
            try {
                return JSON.parse(localStorage.getItem(DB_KEYS.FLEETS) || '[]');
            } catch (e) { return []; }
        };
        const saveFleets = (data) => localStorage.setItem(DB_KEYS.FLEETS, JSON.stringify(data));

        const getRoutes = () => {
            try {
                return JSON.parse(localStorage.getItem(DB_KEYS.ROUTES) || '[]');
            } catch (e) { return []; }
        };
        const saveRoutes = (data) => localStorage.setItem(DB_KEYS.ROUTES, JSON.stringify(data));

        const getOrders = () => {
            try {
                return JSON.parse(localStorage.getItem(DB_KEYS.ORDERS) || '[]');
            } catch (e) { return []; }
        };
        const saveOrders = (data) => localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify(data));

        // --- ÁªÑ‰ª∂ÂÆö‰πâ ---

        // 4. Ê¥æËΩ¶ÂçïÁîüÊàêÁªÑ‰ª∂ (Êñ∞Â¢û)
        const DispatchGenerator = ({ routes, addresses, editingOrder, onOrderComplete, onCancelEdit }) => {
            const [form] = Form.useForm();
            const [selectedRoute, setSelectedRoute] = useState(null);
            const [currentStops, setCurrentStops] = useState([]);
            const [printData, setPrintData] = useState(null);
            const [fleets, setFleets] = useState([]);

            // Âä†ËΩΩËΩ¶ÈòüÂéÜÂè≤ËÆ∞ÂΩï
            useEffect(() => {
                setFleets(getFleets());
            }, []);

            // ÁõëÂê¨ÁºñËæëÁä∂ÊÄÅ
            useEffect(() => {
                if (editingOrder) {
                    // Â°´ÂÖÖË°®Âçï
                    form.setFieldsValue({
                        routeSelect: editingOrder.routeSelect, // Â∞ùËØï‰øùÁïôÈÄâÊã©Áä∂ÊÄÅ
                        shipmentId: editingOrder.shipmentId,
                        poNumber: editingOrder.poNumber,
                        fleet: editingOrder.fleet,
                        vehicleType: editingOrder.vehicleType,
                        pickupDate: editingOrder.pickupDate ? dayjs(editingOrder.pickupDate) : null,
                        deliveryDate: editingOrder.deliveryDate ? dayjs(editingOrder.deliveryDate) : null,
                        cargoDescription: editingOrder.cargoDescription,
                        cargoCount: editingOrder.cargoCount,
                        cargoCbm: editingOrder.cargoCbm,
                        cargoWeight: editingOrder.cargoWeight,
                        note: editingOrder.note
                    });
                    
                    // ÊÅ¢Â§çË∑ØÁ∫øÈÄâÊã©Áä∂ÊÄÅ (Â¶ÇÊûúÂ≠òÂú®)
                    if (editingOrder.routeSelect) {
                         const route = routes.find(r => r.id === editingOrder.routeSelect);
                         if (route) setSelectedRoute(route);
                         else setSelectedRoute({ name: editingOrder.routeName }); // Fallback name
                    } else {
                         setSelectedRoute({ name: editingOrder.routeName });
                    }

                    // ÊÅ¢Â§çÁ´ôÁÇπ
                    setCurrentStops(editingOrder.stops || []);
                    message.info('Â∑≤Âä†ËΩΩËÆ¢ÂçïÊï∞ÊçÆÔºå‰øÆÊîπÂêéÁÇπÂáª‚Äú‰øùÂ≠òÂπ∂ÈáçÊñ∞ÁîüÊàê‚ÄùÂç≥ÂèØÊõ¥Êñ∞');
                }
            }, [editingOrder, form, routes]);

            const handleRouteSelect = (routeId) => {
                const route = routes.find(r => r.id === routeId);
                if (route) {
                    setSelectedRoute(route);
                    setCurrentStops(route.stops.map((s, i) => ({ key: Date.now() + i, addressId: s.addressId })));
                    
                    // Ëá™Âä®Â°´ÂÖÖË°®Âçï
                    form.setFieldsValue({
                        cargoDescription: route.cargo?.description,
                        cargoCount: route.cargo?.count,
                        cargoCbm: route.cargo?.cbm,
                        cargoWeight: route.cargo?.weight,
                        note: route.cargo?.note
                    });
                    message.success('Â∑≤Ëá™Âä®Âä†ËΩΩÁ∫øË∑Ø‰ø°ÊÅØ');
                }
            };

            const handleAddStop = () => {
                setCurrentStops([...currentStops, { key: Date.now(), addressId: null }]);
            };

            const handleRemoveStop = (index) => {
                const newStops = [...currentStops];
                newStops.splice(index, 1);
                setCurrentStops(newStops);
            };

            const handleStopChange = (index, value) => {
                const newStops = [...currentStops];
                newStops[index].addressId = value;
                setCurrentStops(newStops);

                const addr = addresses.find(a => a.id === value);
                if (addr && addr.note) {
                    const currentNote = form.getFieldValue('note') || '';
                    if (!currentNote.includes(addr.note)) {
                        const newNote = currentNote ? `${currentNote}\n${addr.note}` : addr.note;
                        form.setFieldsValue({ note: newNote });
                        message.info(`Â∑≤Ëá™Âä®Ê∑ªÂä†Âú∞ÂùÄÂ§áÊ≥®: ${addr.note}`);
                    }
                }
            };

            const getAddressDetails = (addressId) => addresses.find(a => a.id === addressId) || {};

            const handleReset = () => {
                form.resetFields();
                setSelectedRoute(null);
                setCurrentStops([]);
                setPrintData(null);
                message.success('Â∑≤ÈáçÁΩÆ');
            };

            const handleDeleteFleet = (fleetValue) => {
                const newFleets = fleets.filter(f => f.value !== fleetValue);
                setFleets(newFleets);
                saveFleets(newFleets);
                message.success('Â∑≤Âà†Èô§ËΩ¶ÈòüËÆ∞ÂΩï');
            };

            const handleGenerate = () => {
                form.validateFields().then(values => {
                    const routeName = selectedRoute?.name || '';
                    
                    // --- ‰øùÂ≠òÊñ∞ËΩ¶Èòü ---
                    const newFleet = values.fleet;
                    if (newFleet && !fleets.some(f => f.value === newFleet)) {
                        const updatedFleets = [...fleets, { value: newFleet }];
                        setFleets(updatedFleets);
                        saveFleets(updatedFleets);
                    }

                    const data = {
                        ...values,
                        stops: currentStops,
                        routeName: routeName
                    };
                    setPrintData(data);
                    
                    // --- ËÆ¢ÂçïËÆ∞ÂΩïÈÄªËæë ---
                    const orders = getOrders();
                    const now = new Date().toISOString();
                    
                    if (editingOrder) {
                        // Êõ¥Êñ∞Áé∞ÊúâËÆ¢Âçï
                        const updatedOrders = orders.map(o => o.id === editingOrder.id ? { ...o, ...data, updatedAt: now } : o);
                        saveOrders(updatedOrders);
                        message.success('ËÆ¢ÂçïËÆ∞ÂΩïÂ∑≤Êõ¥Êñ∞');
                        if (onOrderComplete) onOrderComplete();
                    } else {
                        // ÂàõÂª∫Êñ∞ËÆ¢Âçï
                        const newOrder = {
                            id: Date.now().toString(),
                            createdAt: now,
                            updatedAt: now,
                            ...data
                        };
                        saveOrders([newOrder, ...orders]); // Êñ∞ËÆ¢ÂçïÊéíÂú®ÊúÄÂâç
                        message.success('Â∑≤Ëá™Âä®‰øùÂ≠òÂà∞ËÆ¢ÂçïËÆ∞ÂΩï');
                    }

                    // ÊûÑÈÄ†Êñá‰ª∂Âêç: Ê¥æËΩ¶Âçï-Shipment-PO-ÊèêË¥ßÊó•Êúü-Ë∑ØÁ∫øÂêçÁß∞
                    const shipmentId = values.shipmentId || 'Êó†ÂçïÂè∑';
                    const poNumber = values.poNumber || 'Êó†PO';
                    const pickupDate = values.pickupDate ? dayjs(values.pickupDate).format('YYYY-MM-DD') : 'Êó†Êó•Êúü';
                    const safeRouteName = routeName || 'Êó†Ë∑ØÁ∫ø';
                    
                    const fileName = `Ê¥æËΩ¶Âçï-${shipmentId}-${poNumber}-${pickupDate}-${safeRouteName}`;
                    
                    // ‰øùÂ≠òÂéüÊúâÊ†áÈ¢òÂπ∂ËÆæÁΩÆÊñ∞Ê†áÈ¢ò
                    const oldTitle = document.title;
                    document.title = fileName;

                    // Âª∂Ëøü‰∏ÄÂ∞èÊÆµÊó∂Èó¥Á≠âÂæÖ React Ê∏≤ÊüìÊâìÂç∞ÂÜÖÂÆπ
                    setTimeout(() => {
                        window.print();
                        
                        // ÊâìÂç∞ÂØπËØùÊ°ÜÂÖ≥Èó≠ÂêéÊÅ¢Â§çÊ†áÈ¢ò (Âª∂ËøüÊâßË°å‰ª•Á°Æ‰øùÊâìÂç∞ÂØπËØùÊ°ÜÂ∑≤Ëé∑ÂèñÂà∞Ê†áÈ¢ò)
                        setTimeout(() => {
                            document.title = oldTitle;
                        }, 1000);
                    }, 100);
                });
            };

            return (
                <div>
                    {/* ÊâìÂç∞ÂÜÖÂÆπÊåÇËΩΩ */}
                    {printData && ReactDOM.createPortal(
                        <DispatchSheetPrint data={printData} addresses={addresses} />,
                        document.getElementById('print-root')
                    )}

                    <Card bordered={false} style={{ marginBottom: 24, boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' }}>
                        <div className="section-title" style={{ fontSize: '1.125rem', marginBottom: 24 }}>
                            <span style={{ fontSize: '1.25rem' }}>üìÑ</span>
                            ÁîüÊàêÊ¥æËΩ¶Âçï
                        </div>
                        
                        <Form form={form} layout="vertical">
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 16 }}>
                                <Form.Item name="routeSelect" label="ÈÄâÊã©Á∫øË∑Ø" required style={{ marginBottom: 0 }}>
                                    <Select 
                                        showSearch
                                        placeholder="ËØ∑ÈÄâÊã©‰∏ÄÊù°Á∫øË∑Ø..."
                                        optionFilterProp="children"
                                        onChange={handleRouteSelect}
                                        size="large"
                                        variant="filled"
                                        style={{ fontWeight: 500 }}
                                    >
                                        {routes.map(r => (
                                            <Select.Option key={r.id} value={r.id}>
                                                {r.name}
                                            </Select.Option>
                                        ))}
                                    </Select>
                                </Form.Item>
                            </div>

                            <div style={{ marginTop: 0 }}>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                    <Form.Item 
                                        name="shipmentId" 
                                        label="Shipment" 
                                        style={{ marginBottom: 0 }}
                                        rules={[
                                            ({ getFieldValue }) => ({
                                                validator(_, value) {
                                                    if (value || getFieldValue('poNumber')) {
                                                        return Promise.resolve();
                                                    }
                                                    return Promise.reject(new Error('Shipment ID Êàñ PO Âè∑Á†ÅËá≥Â∞ëÂ°´ÂÜô‰∏ÄÈ°π'));
                                                },
                                            }),
                                        ]}
                                    >
                                        <Input size="large" variant="filled" placeholder="ËØ∑ËæìÂÖ• Shipment ID" />
                                    </Form.Item>
                                    <Form.Item 
                                        name="poNumber" 
                                        label="PO" 
                                        style={{ marginBottom: 0 }}
                                        rules={[
                                            ({ getFieldValue }) => ({
                                                validator(_, value) {
                                                    if (value || getFieldValue('shipmentId')) {
                                                        return Promise.resolve();
                                                    }
                                                    return Promise.reject(new Error('Shipment ID Êàñ PO Âè∑Á†ÅËá≥Â∞ëÂ°´ÂÜô‰∏ÄÈ°π'));
                                                },
                                            }),
                                        ]}
                                    >
                                        <Input size="large" variant="filled" placeholder="ËØ∑ËæìÂÖ• PO Number" />
                                    </Form.Item>
                                    <Form.Item 
                                        name="fleet" 
                                        label="ÊâøËøêËΩ¶Èòü" 
                                        style={{ marginBottom: 0 }}
                                        rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•ÊâøËøêËΩ¶Èòü' }]}
                                    >
                                        <AutoComplete
                                            options={fleets.map(f => ({
                                                value: f.value,
                                                label: (
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                        <span>{f.value}</span>
                                                        <span 
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                e.preventDefault();
                                                                handleDeleteFleet(f.value);
                                                            }}
                                                            style={{ 
                                                                color: '#999', 
                                                                cursor: 'pointer', 
                                                                padding: '0 8px',
                                                                fontSize: '16px',
                                                                fontWeight: 'bold'
                                                            }}
                                                            title="Âà†Èô§Ê≠§ËÆ∞ÂΩï"
                                                            onMouseEnter={(e) => e.target.style.color = '#ff4d4f'}
                                                            onMouseLeave={(e) => e.target.style.color = '#999'}
                                                        >
                                                            √ó
                                                        </span>
                                                    </div>
                                                )
                                            }))}
                                            filterOption={(inputValue, option) =>
                                                option.value.toUpperCase().indexOf(inputValue.toUpperCase()) !== -1
                                            }
                                            size="large"
                                            variant="filled"
                                            placeholder="ËæìÂÖ•ÊàñÈÄâÊã©ËΩ¶Èòü"
                                        />
                                    </Form.Item>
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '24px' }}>
                                    <Form.Item 
                                        name="vehicleType" 
                                        label="ËΩ¶Âûã" 
                                        style={{ marginBottom: 0 }}
                                        rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•ËΩ¶Âûã' }]}
                                    >
                                        <Input size="large" variant="filled" placeholder="‰æãÂ¶ÇÔºö2Âè∞5Âê®ËΩ¶ / 40HQ" />
                                    </Form.Item>
                                    <Form.Item 
                                        name="pickupDate" 
                                        label="ÊèêË¥ßÊó•Êúü" 
                                        style={{ marginBottom: 0 }}
                                        rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©ÊèêË¥ßÊó•Êúü' }]}
                                    >
                                        <DatePicker size="large" variant="filled" style={{width: '100%'}} placeholder="ÈÄâÊã©ÊèêË¥ßÊó•Êúü" />
                                    </Form.Item>
                                    <Form.Item 
                                        name="deliveryDate" 
                                        label="ÈÄÅË¥ßÊó•Êúü" 
                                        style={{ marginBottom: 0 }}
                                        rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©ÈÄÅË¥ßÊó•Êúü' }]}
                                    >
                                        <DatePicker size="large" variant="filled" style={{width: '100%'}} placeholder="ÈÄâÊã©ÈÄÅË¥ßÊó•Êúü" />
                                    </Form.Item>
                                </div>

                                <Divider orientation="left">Á´ôÁÇπÁÆ°ÁêÜ</Divider>
                                <div style={{ backgroundColor: '#f9fafb', padding: 16, borderRadius: 8, borderWidth: 1, borderColor: '#f3f4f6', borderStyle: 'solid', marginBottom: 24 }}>
                                    {currentStops.length > 0 ? (
                                        currentStops.map((stop, index) => (
                                            <div key={stop.key} style={{ display: 'flex', gap: 16, marginBottom: 16, alignItems: 'start' }}>
                                                <div style={{ 
                                                    width: 32, 
                                                    height: 32, 
                                                    borderRadius: '50%', 
                                                    backgroundColor: '#e5e7eb', 
                                                    display: 'flex', 
                                                    alignItems: 'center', 
                                                    justifyContent: 'center', 
                                                    fontWeight: 'bold', 
                                                    color: '#4b5563',
                                                    flexShrink: 0,
                                                    marginTop: 4
                                                }}>
                                                    {index + 1}
                                                </div>
                                                <div style={{ flex: 1 }}>
                                                    <Select
                                                        showSearch
                                                        placeholder="ËØ∑ÈÄâÊã©Âú∞ÂùÄ..."
                                                        optionFilterProp="children"
                                                        value={stop.addressId}
                                                        onChange={(val) => handleStopChange(index, val)}
                                                        style={{ width: '100%' }}
                                                        size="large"
                                                        variant="filled"
                                                    >
                                                        {addresses.map(addr => (
                                                            <Select.Option key={addr.id} value={addr.id}>
                                                                {addr.name} - {addr.contactPerson}
                                                            </Select.Option>
                                                        ))}
                                                    </Select>
                                                    {stop.addressId && (
                                                        <div style={{ marginTop: 8, fontSize: 12, color: '#6b7280' }}>
                                                            {(() => {
                                                                const addr = addresses.find(a => a.id === stop.addressId);
                                                                return addr ? `${addr.location || ''} ${addr.contactInfo || ''}` : '';
                                                            })()}
                                                        </div>
                                                    )}
                                                </div>
                                                <Button 
                                                    danger 
                                                    type="text" 
                                                    icon={<span style={{fontSize: '1.25rem'}}>√ó</span>}
                                                    onClick={() => handleRemoveStop(index)}
                                                    style={{ marginTop: 4 }}
                                                />
                                            </div>
                                        ))
                                    ) : (
                                        <Empty description="ÊöÇÊó†Á´ôÁÇπÔºåËØ∑Ê∑ªÂä†" image={Empty.PRESENTED_IMAGE_SIMPLE} />
                                    )}
                                    <Button type="dashed" onClick={handleAddStop} block size="large" icon={<span style={{marginRight: 8}}>+</span>}>
                                        Ê∑ªÂä†Á´ôÁÇπ
                                    </Button>
                                </div>

                                <Divider orientation="left">Ë¥ßÁâ©‰ø°ÊÅØ</Divider>
                                <div style={{ display: 'grid', gridTemplateColumns: '3fr 1fr 1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                                    <Form.Item name="cargoDescription" label="Ë¥ßÁâ©ÂêçÁß∞/ÊèèËø∞" style={{ marginBottom: 0 }}>
                                        <Input size="large" variant="filled" />
                                    </Form.Item>
                                    <Form.Item name="cargoCount" label="ÊÄª‰ª∂Êï∞" style={{ marginBottom: 0 }}>
                                        <InputNumber min={0} controls={false} size="large" style={{width: '100%'}} variant="filled" />
                                    </Form.Item>
                                    <Form.Item name="cargoCbm" label="ÊÄª‰ΩìÁßØ (CBM)" style={{ marginBottom: 0 }}>
                                        <InputNumber min={0} controls={false} size="large" style={{width: '100%'}} variant="filled" />
                                    </Form.Item>
                                    <Form.Item name="cargoWeight" label="ÊÄªÈáçÈáè (KG)" style={{ marginBottom: 0 }}>
                                        <InputNumber min={0} controls={false} size="large" style={{width: '100%'}} variant="filled" />
                                    </Form.Item>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr', gap: 24 }}>
                                    <div style={{ gridColumn: '1 / -1' }}>
                                        <Form.Item name="note" label="Â§áÊ≥®‰ø°ÊÅØ">
                                            <Input.TextArea rows={4} variant="filled" />
                                        </Form.Item>
                                    </div>
                                </div>

                                <div style={{ display: 'flex', justifyContent: 'flex-end', gap: 16 }}>
                                    {editingOrder ? (
                                        <>
                                            <Button size="large" onClick={onCancelEdit}>ÂèñÊ∂àÁºñËæë</Button>
                                            <Button type="primary" size="large" style={{ boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)' }} onClick={handleGenerate}>
                                                ‰øùÂ≠ò‰øÆÊîπÂπ∂Êõ¥Êñ∞ËÆ∞ÂΩï
                                            </Button>
                                        </>
                                    ) : (
                                        <>
                                            <Button size="large" onClick={handleReset}>ÈáçÁΩÆ</Button>
                                            <Button type="primary" size="large" style={{ boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)' }} onClick={handleGenerate}>
                                                Á°ÆËÆ§ÁîüÊàêÊ¥æËΩ¶Âçï (PDF)
                                            </Button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </Form>
                    </Card>
                </div>
            );
        };

        // 1. Âú∞ÂùÄÂ∫ìÁªÑ‰ª∂
        const AddressLibrary = ({ addresses, setAddresses }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [form] = Form.useForm();
            const [searchText, setSearchText] = useState('');

            const columns = [
                { title: 'ÂêçÁß∞', dataIndex: 'name', key: 'name', render: t => <Text strong>{t}</Text> },
                { title: 'Âú∞ÂùÄ', dataIndex: 'location', key: 'location' },
                { title: 'ËÅîÁ≥ª‰∫∫', dataIndex: 'contactPerson', key: 'contactPerson' },
                { title: 'ËÅîÁ≥ªÊñπÂºè', dataIndex: 'contactInfo', key: 'contactInfo' },
                { title: 'Â§áÊ≥®', dataIndex: 'note', key: 'note', render: t => t ? <Text type="secondary" ellipsis={{tooltip:t}} style={{maxWidth: 150}}>{t}</Text> : '-' },
                {
                    title: 'Êìç‰Ωú',
                    key: 'action',
                    width: 150,
                    render: (_, record) => (
                        <Space size="small">
                            <Button type="primary" size="small" onClick={() => handleEdit(record)}>ÁºñËæë</Button>
                            <Popconfirm title="Á°ÆÂÆöÂà†Èô§?" onConfirm={() => handleDelete(record.id)}>
                                <Button type="primary" danger size="small">Âà†Èô§</Button>
                            </Popconfirm>
                        </Space>
                    ),
                },
            ];

            const filteredAddresses = addresses.filter(addr => 
                !searchText || 
                addr.name.includes(searchText) || 
                (addr.location && addr.location.includes(searchText)) ||
                (addr.contactPerson && addr.contactPerson.includes(searchText))
            );

            const handleEdit = (record) => {
                setEditingId(record.id);
                form.setFieldsValue(record);
                setIsModalOpen(true);
            };

            const handleDelete = (id) => {
                const newAddresses = addresses.filter(item => item.id !== id);
                setAddresses(newAddresses);
                saveAddresses(newAddresses);
                message.success('Âà†Èô§ÊàêÂäü');
            };

            const handleOk = () => {
                form.validateFields().then(values => {
                    let newAddresses;
                    if (editingId) {
                        newAddresses = addresses.map(item => item.id === editingId ? { ...item, ...values } : item);
                    } else {
                        newAddresses = [...addresses, { id: Date.now().toString(), ...values }];
                    }
                    setAddresses(newAddresses);
                    saveAddresses(newAddresses);
                    setIsModalOpen(false);
                    form.resetFields();
                    setEditingId(null);
                    message.success(editingId ? 'Êõ¥Êñ∞ÊàêÂäü' : 'Ê∑ªÂä†ÊàêÂäü');
                });
            };

            return (
                <div>
                    <Card bordered={false} style={{ boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                                <div style={{ fontSize: '1.125rem', fontWeight: 'bold', whiteSpace: 'nowrap' }}>
                                    Âú∞ÂùÄÂàóË°® <span style={{fontSize: '0.875rem', color: '#6b7280', fontWeight: 'normal'}}>({filteredAddresses.length})</span>
                                </div>
                                <Input 
                                    placeholder="ÊêúÁ¥¢ÂêçÁß∞„ÄÅÂú∞ÂùÄÊàñËÅîÁ≥ª‰∫∫..." 
                                    prefix={<span style={{ color: '#9ca3af', fontSize: '1.125rem' }}>üîç</span>} 
                                    value={searchText}
                                    onChange={e => setSearchText(e.target.value)}
                                    style={{ width: 350 }}
                                    size="large"
                                    variant="filled"
                                    allowClear
                                />
                            </div>
                            <Button 
                                type="primary" 
                                icon={<span>+</span>} 
                                onClick={() => { setEditingId(null); form.resetFields(); setIsModalOpen(true); }}
                                size="large"
                                shape="round"
                                style={{ boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)' }}
                            >
                                Êñ∞Â¢ûÂú∞ÂùÄ
                            </Button>
                        </div>
                        <Table 
                            columns={columns} 
                            dataSource={filteredAddresses} 
                            rowKey="id"
                            pagination={{ pageSize: 8 }}
                            locale={{ emptyText: <Empty description="ÊöÇÊó†Âú∞ÂùÄÊï∞ÊçÆ" image={Empty.PRESENTED_IMAGE_SIMPLE} /> }}
                            scroll={{ x: 800 }}
                        />
                    </Card>

                    <Modal
                        title={editingId ? "ÁºñËæëÂú∞ÂùÄ" : "Êñ∞Â¢ûÂú∞ÂùÄ"}
                        open={isModalOpen}
                        onOk={handleOk}
                        onCancel={() => setIsModalOpen(false)}
                        okText="‰øùÂ≠ò"
                        cancelText="ÂèñÊ∂à"
                        width={600}
                        centered
                    >
                        <Form form={form} layout="vertical" style={{ paddingTop: 16 }}>
                            <Form.Item name="name" label="Â∑•ÂéÇ/Áâ©ÊµÅÂõ≠ÂêçÁß∞" rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•ÂêçÁß∞' }]}>
                                <Input size="large" variant="filled" placeholder="‰æãÂ¶ÇÔºöÊç∑ÈÄöÁâ©ÊµÅÂõ≠" />
                            </Form.Item>
                            <Form.Item name="location" label="ËØ¶ÁªÜÂú∞ÂùÄ" rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•Âú∞ÂùÄ' }]}>
                                <Input size="large" variant="filled" placeholder="‰æãÂ¶ÇÔºöÊ∑±Âú≥Â∏ÇÈæôÂ≤óÂå∫xxË∑ØxxÂè∑" />
                            </Form.Item>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                <Form.Item name="contactPerson" label="ËÅîÁ≥ª‰∫∫">
                                    <Input size="large" variant="filled" placeholder="ÂßìÂêç" />
                                </Form.Item>
                                <Form.Item name="contactInfo" label="ËÅîÁ≥ªÊñπÂºè">
                                    <Input size="large" variant="filled" placeholder="ÁîµËØù/ÊâãÊú∫" />
                                </Form.Item>
                            </div>
                            <Form.Item name="note" label="ÈªòËÆ§Â§áÊ≥® (‰ºöËá™Âä®ÂêàÂπ∂Âà∞Ë∑ØÁ∫øËßÑÂàí‰∏≠)">
                                <Input.TextArea rows={3} variant="filled" placeholder="‰æãÂ¶ÇÔºöËøõÈó®ÈúÄË¶ÅÁôªËÆ∞ÔºåËΩ¶ËæÜÈôêÈ´ò4Á±≥Á≠â" />
                            </Form.Item>
                        </Form>
                    </Modal>
                </div>
            );
        };

        // 2. Ë∑ØÁ∫øËßÑÂàíÁªÑ‰ª∂
        const RoutePlanning = ({ addresses, routes, setRoutes, setActiveTab, editingRoute, setEditingRoute }) => {
            const [form] = Form.useForm();
            const [stops, setStops] = useState([]);
            // ÂÖ®Â±ÄË¥ßÁâ©‰ø°ÊÅØÁä∂ÊÄÅ
            const [cargoInfo, setCargoInfo] = useState({
                description: '',
                count: 0,
                cbm: 0,
                weight: 0,
                note: ''
            });

            // Â¶ÇÊûúÂ§Ñ‰∫éÁºñËæëÊ®°ÂºèÔºåÂàùÂßãÂåñË°®ÂçïÂíåÁä∂ÊÄÅ
            useEffect(() => {
                if (editingRoute) {
                    form.setFieldsValue({ routeName: editingRoute.name });
                    setStops(editingRoute.stops.map((s, i) => ({ key: Date.now() + i, addressId: s.addressId })));
                    setCargoInfo(editingRoute.cargo || { description: '', count: 0, cbm: 0, weight: 0, note: '' });
                }
            }, [editingRoute]);

            const handleCancelEdit = () => {
                setEditingRoute(null);
                form.resetFields();
                setStops([]);
                setCargoInfo({ description: '', count: 0, cbm: 0, weight: 0, note: '' });
                message.info('Â∑≤ÂèñÊ∂àÁºñËæëÔºåÈáçÁΩÆ‰∏∫Êñ∞Âª∫Ê®°Âºè');
            };

            const handleAddStop = () => {
                setStops([...stops, { key: Date.now(), addressId: null }]);
            };

            const handleRemoveStop = (index) => {
                const newStops = [...stops];
                newStops.splice(index, 1);
                setStops(newStops);
            };

            const handleStopChange = (index, value) => {
                const newStops = [...stops];
                newStops[index].addressId = value;
                setStops(newStops);

                // Ëá™Âä®Â°´ÂÖÖÈÄªËæëÔºöËé∑ÂèñÈÄâ‰∏≠Âú∞ÂùÄÁöÑÂ§áÊ≥®ÔºåÂπ∂ËøΩÂä†Âà∞Ë¥ßÁâ©Â§áÊ≥®‰∏≠
                const addr = addresses.find(a => a.id === value);
                if (addr && addr.note) {
                    // Ê£ÄÊü•ÂΩìÂâçÂ§áÊ≥®ÊòØÂê¶Â∑≤ÂåÖÂê´ËØ•Âú∞ÂùÄÂ§áÊ≥®ÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
                    const currentNote = cargoInfo.note || '';
                    if (!currentNote.includes(addr.note)) {
                        const newNote = currentNote ? `${currentNote}\n${addr.note}` : addr.note;
                        setCargoInfo(prev => ({ ...prev, note: newNote }));
                        message.info(`Â∑≤Ëá™Âä®Ê∑ªÂä†Âú∞ÂùÄÂ§áÊ≥®: ${addr.note}`);
                    }
                }
            };

            const handleSaveRoute = () => {
                form.validateFields().then(values => {
                    if (stops.length === 0) {
                        message.error('ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏Ä‰∏™Á´ôÁÇπ');
                        return;
                    }
                    for (let stop of stops) {
                        if (!stop.addressId) {
                            message.error('ËØ∑‰∏∫ÊâÄÊúâÁ´ôÁÇπÈÄâÊã©Âú∞ÂùÄ');
                            return;
                        }
                    }

                    const routeData = {
                        id: editingRoute ? editingRoute.id : Date.now().toString(),
                        name: values.routeName,
                        // Êñ∞ÁöÑÊï∞ÊçÆÁªìÊûÑÔºöÁ´ôÁÇπÂè™ÂåÖÂê´Âú∞ÂùÄID
                        stops: stops.map(s => ({
                            addressId: s.addressId
                        })),
                        // ÂÖ®Â±ÄË¥ßÁâ©‰ø°ÊÅØ
                        cargo: { ...cargoInfo },
                        createdAt: editingRoute ? editingRoute.createdAt : new Date().toISOString()
                    };

                    let newRoutes;
                    if (editingRoute) {
                        newRoutes = routes.map(r => r.id === editingRoute.id ? routeData : r);
                        message.success('Ë∑ØÁ∫øÊõ¥Êñ∞ÊàêÂäü');
                    } else {
                        newRoutes = [routeData, ...routes];
                        message.success('Ë∑ØÁ∫øÂàõÂª∫ÊàêÂäü');
                    }

                    setRoutes(newRoutes);
                    saveRoutes(newRoutes);
                    
                    // ÈáçÁΩÆË°®Âçï
                    form.resetFields();
                    setStops([]);
                    setCargoInfo({ description: '', count: 0, cbm: 0, weight: 0, note: '' });
                    setEditingRoute(null);
                    setActiveTab('3'); // Ë∑≥ËΩ¨Âà∞ÁÆ°ÁêÜÈ°µ
                });
            };

            return (
                <div style={{ maxWidth: 1000, margin: '0 auto' }}>
                    <Card bordered={false} style={{ marginBottom: 24, boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
                            <div className="section-title" style={{ fontSize: '1.25rem' }}>
                                <span style={{ fontSize: '1.5rem' }}>üìù</span>
                                {editingRoute ? 'ÁºñËæëË∑ØÁ∫ø‰ø°ÊÅØ' : 'Êñ∞Âª∫Ë∑ØÁ∫øËßÑÂàí'}
                            </div>
                            {editingRoute && (
                                <Button onClick={handleCancelEdit} type="default" danger shape="round">
                                    ÂèñÊ∂àÁºñËæë
                                </Button>
                            )}
                        </div>
                        <Form form={form} layout="vertical">
                            <Form.Item name="routeName" label={<span style={{ fontWeight: 'bold', color: '#374151' }}>Ë∑ØÁ∫øÂêçÁß∞</span>} rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•Ë∑ØÁ∫øÂêçÁß∞' }]}>
                                <Input size="large" placeholder="‰æãÂ¶ÇÔºö2023-10-27 Ê∑±Âú≥-‰∏úËéû-ÊÉ†Â∑û ÊãºËΩ¶" variant="filled" style={{fontSize: 16}} />
                            </Form.Item>
                        </Form>
                    </Card>

                    <Card bordered={false} style={{ marginBottom: 24, boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                            <div className="section-title" style={{ fontSize: '1.125rem' }}>
                                <span style={{ fontSize: '1.25rem' }}>üìç</span>
                                Á´ôÁÇπÈÄâÊã© ({stops.length})
                            </div>
                            <Button type="primary" ghost onClick={handleAddStop} icon={<span>+</span>} shape="round">Ê∑ªÂä†Á´ôÁÇπ</Button>
                        </div>
                        
                        {stops.length === 0 && (
                            <div style={{ padding: 32, backgroundColor: '#f9fafb', borderRadius: 8, border: '1px dashed #d1d5db', display: 'flex', justifyContent: 'center' }}>
                                <Empty description="ÊöÇÊó†Á´ôÁÇπÔºåËØ∑ÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†" image={Empty.PRESENTED_IMAGE_SIMPLE} />
                            </div>
                        )}

                        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                            {stops.map((stop, index) => (
                                <div key={stop.key} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 12, backgroundColor: 'white', borderWidth: 1, borderColor: '#f3f4f6', borderStyle: 'solid', borderRadius: 8, boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' }}>
                                    <div style={{ backgroundColor: '#2563eb', color: 'white', borderRadius: 9999, width: 32, height: 32, display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 'bold', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)', flexShrink: 0 }}>
                                        {index + 1}
                                    </div>
                                    <Select 
                                        showSearch
                                        placeholder="ÊêúÁ¥¢Âú∞ÂùÄÂ∫ìÔºàÊîØÊåÅÂêçÁß∞/Âú∞ÂùÄÊ®°Á≥äÊêúÁ¥¢Ôºâ..."
                                        filterOption={(input, option) => 
                                            (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                                        }
                                        value={stop.addressId}
                                        onChange={(val) => handleStopChange(index, val)}
                                        style={{ width: '100%', fontWeight: 500 }}
                                        size="large"
                                        variant="borderless"
                                        status={!stop.addressId ? 'warning' : ''}
                                    >
                                        {addresses.map(addr => (
                                            <Select.Option 
                                                key={addr.id} 
                                                value={addr.id}
                                                label={`${addr.name} ${addr.location}`}
                                            >
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', width: '100%' }}>
                                                    <span style={{ fontWeight: 'bold', color: '#1f2937' }}>{addr.name}</span>
                                                    <span style={{ color: '#9ca3af', fontSize: 14, marginLeft: 8 }}>{addr.location}</span>
                                                </div>
                                            </Select.Option>
                                        ))}
                                    </Select>
                                    <Button 
                                        type="text" 
                                        danger 
                                        onClick={() => handleRemoveStop(index)}
                                        style={{ borderRadius: 9999 }}
                                        icon={<span style={{ fontSize: '1.125rem' }}>√ó</span>}
                                    />
                                </div>
                            ))}
                        </div>
                    </Card>

                    <Card bordered={false} style={{ marginBottom: 32, boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)', background: 'linear-gradient(to bottom, #ffffff, #f8fafc)' }}>
                        <div className="section-title" style={{ fontSize: '1.125rem', marginBottom: 24 }}>
                            <span style={{ fontSize: '1.25rem' }}>üì¶</span>
                            Ë¥ßÁâ©‰ø°ÊÅØ
                        </div>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(12, 1fr)', gap: 24 }}>
                            <div style={{ gridColumn: 'span 12' }}>
                                <Text style={{ display: 'block', fontWeight: 500, color: '#4b5563', marginBottom: 8 }}>Ë¥ßÁâ©ÂêçÁß∞/ÊèèËø∞</Text>
                                <Input 
                                    size="large"
                                    placeholder="‰æãÂ¶ÇÔºöÁîµÂ≠êÈÖç‰ª∂ ‰∏ÄÊâπ" 
                                    value={cargoInfo.description}
                                    variant="filled"
                                    onChange={e => setCargoInfo({...cargoInfo, description: e.target.value})}
                                />
                            </div>
                            <div style={{ gridColumn: 'span 4' }}>
                                <Text style={{ display: 'block', fontWeight: 500, color: '#4b5563', marginBottom: 8 }}>ÊÄª‰ª∂Êï∞</Text>
                                <InputNumber 
                                    min={0} 
                                    controls={false}
                                    size="large"
                                    style={{ width: '100%' }} 
                                    variant="filled"
                                    value={cargoInfo.count}
                                    onChange={val => setCargoInfo({...cargoInfo, count: val})}
                                />
                            </div>
                            <div style={{ gridColumn: 'span 4' }}>
                                <Text style={{ display: 'block', fontWeight: 500, color: '#4b5563', marginBottom: 8 }}>ÊÄªCBM (Á´ãÊñπ)</Text>
                                <InputNumber 
                                    min={0} 
                                    controls={false}
                                    size="large"
                                    style={{ width: '100%' }} 
                                    variant="filled"
                                    value={cargoInfo.cbm}
                                    onChange={val => setCargoInfo({...cargoInfo, cbm: val})}
                                />
                            </div>
                            <div style={{ gridColumn: 'span 4' }}>
                                <Text style={{ display: 'block', fontWeight: 500, color: '#4b5563', marginBottom: 8 }}>ÊÄªÈáçÈáè (KG)</Text>
                                <InputNumber 
                                    min={0} 
                                    controls={false}
                                    size="large"
                                    style={{ width: '100%' }} 
                                    variant="filled"
                                    value={cargoInfo.weight}
                                    onChange={val => setCargoInfo({...cargoInfo, weight: val})}
                                />
                            </div>
                            <div style={{ gridColumn: 'span 12' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
                                    <Text style={{ fontWeight: 500, color: '#4b5563' }}>Ë¥ßÁâ©/Êìç‰ΩúÂ§áÊ≥®</Text>
                                    <Tag color="orange">Ëá™Âä®ÂêàÂπ∂Âú∞ÂùÄÂ∫ìÂ§áÊ≥®</Tag>
                                </div>
                                <Input.TextArea 
                                    rows={4} 
                                    placeholder="ÈÄâÊã©Âú∞ÂùÄÂêéÔºåÂú∞ÂùÄÂ∫ìÁöÑÂ§áÊ≥®‰ºöËá™Âä®ËøΩÂä†Âà∞ËøôÈáå"
                                    value={cargoInfo.note}
                                    variant="filled"
                                    onChange={e => setCargoInfo({...cargoInfo, note: e.target.value})}
                                    style={{ backgroundColor: '#fffbe6', borderColor: '#ffe58f' }}
                                />
                            </div>
                        </div>
                    </Card>

                    <div style={{ display: 'flex', gap: 16 }}>
                        <Button 
                            type="primary" 
                            size="large" 
                            block 
                            onClick={handleSaveRoute} 
                            style={{ height: 56, fontSize: 18, fontWeight: 'bold', borderRadius: 28, background: 'linear-gradient(to right, #2563eb, #3b82f6)', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }} 
                            disabled={stops.length === 0}
                        >
                            {editingRoute ? 'Êõ¥Êñ∞Ë∑ØÁ∫ø‰ø°ÊÅØ' : '‰øùÂ≠òÂπ∂ÁîüÊàêË∑ØÁ∫ø'}
                        </Button>
                    </div>
                </div>
            );
        };

        // 3. Á∫øË∑ØÁÆ°ÁêÜÁªÑ‰ª∂
        const RouteManagement = ({ routes, addresses, setRoutes, setActiveTab, setEditingRoute }) => {
            const [searchText, setSearchText] = useState('');

            // Ëé∑ÂèñÊúÄÊñ∞Âú∞ÂùÄ‰ø°ÊÅØÁöÑÂ∏ÆÂä©ÂáΩÊï∞
            const getAddressDetails = (addressId) => addresses.find(a => a.id === addressId) || {};

            const handleDeleteRoute = (id) => {
                const newRoutes = routes.filter(r => r.id !== id);
                setRoutes(newRoutes);
                saveRoutes(newRoutes);
                message.success('Ë∑ØÁ∫øÂ∑≤Âà†Èô§');
            };

            const handleEditRoute = (record) => {
                setEditingRoute(record);
                setActiveTab('2');
                message.info('ËøõÂÖ•ÁºñËæëÊ®°Âºè');
            };

            const filteredRoutes = routes.filter(r => 
                !searchText || 
                r.name.toLowerCase().includes(searchText.toLowerCase()) ||
                (r.cargo && r.cargo.description && r.cargo.description.includes(searchText))
            );

            const columns = [
                {
                    title: 'Ë∑ØÁ∫øÂêçÁß∞',
                    dataIndex: 'name',
                    key: 'name',
                    render: (text, record) => (
                        <div>
                            <div style={{fontWeight: 'bold', fontSize: 15}}>{text}</div>
                            <div style={{fontSize: 12, color: '#888'}}>{new Date(record.createdAt).toLocaleDateString()}</div>
                        </div>
                    )
                },
                {
                    title: 'Ë¥ßÁâ©‰ø°ÊÅØÊ¶ÇËßà',
                    key: 'cargo',
                    render: (_, record) => {
                        if (!record.cargo) return '-';
                        return (
                            <div style={{fontSize: 13}}>
                                <div><Text strong>{record.cargo.description || 'Êó†ÊèèËø∞'}</Text></div>
                                <Space size="small" style={{color: '#666'}}>
                                    <span>{record.cargo.count}‰ª∂</span>
                                    <span>|</span>
                                    <span>{record.cargo.cbm}m¬≥</span>
                                    <span>|</span>
                                    <span>{record.cargo.weight}kg</span>
                                </Space>
                            </div>
                        );
                    }
                },
                {
                    title: 'Êìç‰Ωú',
                    key: 'action',
                    width: 150,
                    render: (_, record) => (
                        <Space size="small">
                            <Button type="primary" size="small" onClick={() => handleEditRoute(record)}>ÁºñËæë</Button>
                            <Popconfirm title="Á°ÆÂÆöÂà†Èô§Ê≠§Ë∑ØÁ∫ø?" onConfirm={() => handleDeleteRoute(record.id)}>
                                <Button type="primary" danger size="small">Âà†Èô§</Button>
                            </Popconfirm>
                        </Space>
                    )
                }
            ];

            const expandedRowRender = (record) => {
                return (
                    <div style={{ backgroundColor: '#f9fafb', padding: 16, borderRadius: 4 }}>
                        {record.cargo && record.cargo.note && (
                            <div style={{ marginBottom: 16 }}>
                                <Text strong style={{ display: 'block', marginBottom: 4, color: '#ea580c' }}>üìù Ë¥ßÁâ©/Êìç‰ΩúÂ§áÊ≥®Ôºö</Text>
                                <div style={{ padding: 8, backgroundColor: '#fefce8', borderWidth: 1, borderColor: '#fef9c3', borderStyle: 'solid', borderRadius: 4, color: '#374151', whiteSpace: 'pre-wrap' }}>
                                    {record.cargo.note}
                                </div>
                            </div>
                        )}
                        
                        <Table 
                            dataSource={record.stops} 
                            pagination={false}
                            rowKey={(r, i) => i}
                            size="small"
                            bordered
                            columns={[
                                { title: 'Â∫èÂè∑', key: 'index', width: 60, align: 'center', render: (_, __, index) => index + 1 },
                                { 
                                    title: 'ÈÄîÂæÑÁ´ôÁÇπËØ¶ÁªÜ‰ø°ÊÅØ', 
                                    key: 'address',
                                    render: (_, stop) => {
                                        const addr = getAddressDetails(stop.addressId);
                                        return (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <span>{addr.name || 'Â∑≤Âà†Èô§Âú∞ÂùÄ'} <Text type="secondary" style={{fontSize: 12}}>({addr.location})</Text></span>
                                                <span>
                                                    <Tag>{addr.contactPerson}</Tag>
                                                    {addr.contactInfo}
                                                </span>
                                            </div>
                                        );
                                    }
                                }
                            ]}
                        />
                    </div>
                );
            };

            return (
                <div>
                    <Card bordered={false} style={{ marginBottom: 24, boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                                <div style={{ fontSize: '1.125rem', fontWeight: 'bold', whiteSpace: 'nowrap' }}>
                                    Á∫øË∑ØÂàóË°® <span style={{fontSize: '0.875rem', color: '#6b7280', fontWeight: 'normal'}}>({filteredRoutes.length})</span>
                                </div>
                                <Input 
                                    placeholder="ÊêúÁ¥¢Ë∑ØÁ∫øÂêçÁß∞ÊàñË¥ßÁâ©‰ø°ÊÅØ..." 
                                    prefix={<span style={{ color: '#9ca3af', fontSize: '1.125rem' }}>üîç</span>} 
                                    value={searchText}
                                    onChange={e => setSearchText(e.target.value)}
                                    style={{ width: 350 }}
                                    size="large"
                                    variant="filled"
                                    allowClear
                                />
                            </div>
                        </div>

                        <Table 
                            columns={columns} 
                            dataSource={filteredRoutes} 
                            rowKey="id"
                            expandable={{ expandedRowRender, expandRowByClick: true, showExpandColumn: false }}
                            pagination={{ pageSize: 10 }}
                            locale={{ emptyText: <Empty description="ÊöÇÊó†Ë∑ØÁ∫øÊï∞ÊçÆ" image={Empty.PRESENTED_IMAGE_SIMPLE} /> }}
                        />
                    </Card>
                </div>
            );
        };


        // 5. ËÆ¢ÂçïËÆ∞ÂΩïÁÆ°ÁêÜÁªÑ‰ª∂ (Êñ∞Â¢û)
        const OrderManagement = ({ addresses, onEditOrder }) => {
            const [orders, setOrders] = React.useState([]);
            const [printData, setPrintData] = React.useState(null);
            const [searchText, setSearchText] = React.useState('');
            const [selectedRowKeys, setSelectedRowKeys] = React.useState([]);

            React.useEffect(() => {
                setOrders(getOrders());
            }, []);

            const refreshOrders = () => {
                setOrders(getOrders());
                setSelectedRowKeys([]); // Âà∑Êñ∞Êó∂Ê∏ÖÁ©∫ÈÄâÊã©
                message.success('ÂàóË°®Â∑≤Âà∑Êñ∞');
            };

            const handleDelete = (id) => {
                const newOrders = orders.filter(o => o.id !== id);
                saveOrders(newOrders);
                setOrders(newOrders);
                setSelectedRowKeys(selectedRowKeys.filter(key => key !== id));
                message.success('ËÆ∞ÂΩïÂ∑≤Âà†Èô§');
            };

            const handleReprint = (record) => {
                setPrintData(record);
                
                // ÊûÑÈÄ†Êñá‰ª∂Âêç
                const shipmentId = record.shipmentId || 'Êó†ÂçïÂè∑';
                const poNumber = record.poNumber || 'Êó†PO';
                const pickupDate = record.pickupDate ? dayjs(record.pickupDate).format('YYYY-MM-DD') : 'Êó†Êó•Êúü';
                const safeRouteName = record.routeName || 'Êó†Ë∑ØÁ∫ø';
                const fileName = `Ê¥æËΩ¶Âçï-${shipmentId}-${poNumber}-${pickupDate}-${safeRouteName}`;
                
                const oldTitle = document.title;
                document.title = fileName;

                setTimeout(() => {
                    window.print();
                    setTimeout(() => {
                        document.title = oldTitle;
                        setPrintData(null); 
                    }, 1000);
                }, 100);
            };

            const handleExport = () => {
                if (selectedRowKeys.length === 0) {
                    message.warning('ËØ∑ÂÖàÂãæÈÄâË¶ÅÂØºÂá∫ÁöÑËÆ¢Âçï');
                    return;
                }

                const selectedOrders = orders.filter(o => selectedRowKeys.includes(o.id));
                
                // ÂáÜÂ§áÂØºÂá∫Êï∞ÊçÆ
                const exportData = selectedOrders.map(o => ({
                    'Shipment ID': o.shipmentId,
                    'PO Âè∑Á†Å': o.poNumber,
                    'Ë∑ØÁ∫øÂêçÁß∞': o.routeName,
                    'ÊâøËøêËΩ¶Èòü': o.fleet,
                    'ËΩ¶Âûã': o.vehicleType,
                    'ÊèêË¥ßÊó•Êúü': o.pickupDate ? dayjs(o.pickupDate).format('YYYY-MM-DD') : '',
                    'ÈÄÅË¥ßÊó•Êúü': o.deliveryDate ? dayjs(o.deliveryDate).format('YYYY-MM-DD') : '',
                    'Ë¥ßÁâ©ÊèèËø∞': o.cargoDescription,
                    '‰ª∂Êï∞': o.cargoCount,
                    '‰ΩìÁßØ(CBM)': o.cargoCbm,
                    'ÈáçÈáè(KG)': o.cargoWeight,
                    'Â§áÊ≥®': o.note
                }));

                try {
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "ËÆ¢ÂçïËÆ∞ÂΩï");
                    XLSX.writeFile(wb, `ËÆ¢ÂçïÂØºÂá∫_${dayjs().format('YYYYMMDD_HHmmss')}.xlsx`);
                    message.success(`ÊàêÂäüÂØºÂá∫ ${selectedOrders.length} Êù°ËÆ∞ÂΩï`);
                } catch (error) {
                    console.error('Export error:', error);
                    message.error('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Á°Æ‰øùÁΩëÁªúÊ≠£Â∏∏‰ª•Âä†ËΩΩExcelÁªÑ‰ª∂');
                }
            };

            const handleBatchDelete = () => {
                if (selectedRowKeys.length === 0) {
                    message.warning('ËØ∑ÂÖàÂãæÈÄâË¶ÅÂà†Èô§ÁöÑËÆ¢Âçï');
                    return;
                }

                Modal.confirm({
                    title: 'Á°ÆËÆ§ÊâπÈáèÂà†Èô§',
                    content: `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedRowKeys.length} Êù°ËÆ¢ÂçïËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
                    okText: 'Á°ÆËÆ§Âà†Èô§',
                    okType: 'danger',
                    cancelText: 'ÂèñÊ∂à',
                    onOk() {
                        const newOrders = orders.filter(o => !selectedRowKeys.includes(o.id));
                        saveOrders(newOrders);
                        setOrders(newOrders);
                        setSelectedRowKeys([]);
                        message.success(`ÊàêÂäüÂà†Èô§ ${selectedRowKeys.length} Êù°ËÆ∞ÂΩï`);
                    },
                });
            };

            const filteredOrders = orders.filter(o => 
                !searchText || 
                (o.shipmentId && o.shipmentId.toLowerCase().includes(searchText.toLowerCase())) ||
                (o.poNumber && o.poNumber.toLowerCase().includes(searchText.toLowerCase())) ||
                (o.routeName && o.routeName.toLowerCase().includes(searchText.toLowerCase())) ||
                (o.fleet && o.fleet.toLowerCase().includes(searchText.toLowerCase()))
            );

            const rowSelection = {
                selectedRowKeys,
                onChange: (newSelectedRowKeys) => {
                    setSelectedRowKeys(newSelectedRowKeys);
                },
            };

            const columns = [
                { title: 'Shipment ID', dataIndex: 'shipmentId', key: 'shipmentId' },
                { title: 'PO Âè∑Á†Å', dataIndex: 'poNumber', key: 'poNumber' },
                { title: 'Ë∑ØÁ∫øÂêçÁß∞', dataIndex: 'routeName', key: 'routeName' },
                { title: 'ÊâøËøêËΩ¶Èòü', dataIndex: 'fleet', key: 'fleet' },
                { 
                    title: 'ÊèêË¥ßÊó•Êúü', 
                    dataIndex: 'pickupDate', 
                    key: 'pickupDate',
                    render: t => t ? dayjs(t).format('YYYY-MM-DD') : '-'
                },
                {
                    title: 'Êìç‰Ωú',
                    key: 'action',
                    width: 250,
                    render: (_, record) => (
                        <Space size="small">
                            <Button type="link" size="small" onClick={() => handleReprint(record)}>
                                üñ®Ô∏è ÊâìÂç∞
                            </Button>
                            <Button type="link" size="small" onClick={() => onEditOrder(record)}>
                                ‚úèÔ∏è ÁºñËæë
                            </Button>
                            <Popconfirm title="Á°ÆÂÆöÂà†Èô§Ôºü" onConfirm={() => handleDelete(record.id)}>
                                <Button type="link" size="small" danger>Âà†Èô§</Button>
                            </Popconfirm>
                        </Space>
                    ),
                },
            ];

            return (
                <div>
                    {printData && ReactDOM.createPortal(
                        <DispatchSheetPrint data={printData} addresses={addresses} />,
                        document.getElementById('print-root')
                    )}
                    <Card bordered={false} style={{ marginBottom: 24, boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)' }}>
                        <div className="section-title" style={{ fontSize: '1.125rem', marginBottom: 24, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                                <div>
                                    <span style={{ fontSize: '1.25rem', marginRight: 8 }}>üìã</span>
                                    ÂéÜÂè≤ËÆ¢ÂçïËÆ∞ÂΩï <span style={{fontSize: '0.875rem', color: '#6b7280', fontWeight: 'normal'}}>({filteredOrders.length})</span>
                                </div>
                                <Input 
                                    placeholder="ÊêúÁ¥¢ Shipment ID / PO / Ë∑ØÁ∫ø / ËΩ¶Èòü..." 
                                    prefix={<span style={{ color: '#9ca3af' }}>üîç</span>} 
                                    value={searchText}
                                    onChange={e => setSearchText(e.target.value)}
                                    style={{ width: 350 }}
                                    allowClear
                                />
                            </div>
                            <Space>
                                <Button onClick={handleExport} icon={<span>üìä</span>}>
                                    ÂØºÂá∫Excel
                                </Button>
                                <Button danger onClick={handleBatchDelete} icon={<span>üóëÔ∏è</span>}>
                                    ÊâπÈáèÂà†Èô§
                                </Button>
                                <Button onClick={refreshOrders}>üîÑ Âà∑Êñ∞ÂàóË°®</Button>
                            </Space>
                        </div>
                        <div style={{ marginBottom: 16 }}>
                            <span style={{ marginLeft: 8 }}>
                                {selectedRowKeys.length > 0 ? `Â∑≤ÈÄâÊã© ${selectedRowKeys.length} È°π` : ''}
                            </span>
                        </div>
                        <Table 
                            rowSelection={rowSelection}
                            columns={columns} 
                            dataSource={filteredOrders} 
                            rowKey="id" 
                            pagination={{ pageSize: 10 }} 
                            scroll={{ x: 800 }}
                        />
                    </Card>
                </div>
            );
        };

        // 6. ÊÄªËßà/‰ª™Ë°®ÁõòÁªÑ‰ª∂ (Êñ∞Â¢û)
        const Overview = ({ onNavigate }) => {
            const [orders, setOrders] = useState([]);
            const [pendingDispatch, setPendingDispatch] = useState([]);
            const [inTransit, setInTransit] = useState([]);

            useEffect(() => {
                const allOrders = getOrders();
                setOrders(allOrders);
                processOrders(allOrders);
            }, []);

            const processOrders = (data) => {
                const today = dayjs().startOf('day');
                
                const pending = [];
                const transit = [];

                data.forEach(order => {
                    const pickupDate = order.pickupDate ? dayjs(order.pickupDate).startOf('day') : null;
                    const deliveryDate = order.deliveryDate ? dayjs(order.deliveryDate).endOf('day') : null;

                    if (!pickupDate) return;

                    // 1. ÂæÖÊ¥æËΩ¶Âà§Êñ≠ (Êô∫ËÉΩÊèêÂâçÊèêÈÜí)
                    // ÈÄªËæëÔºöÊèêË¥ßÊó•ÊúüÁöÑÂâç1‰∏™Â∑•‰ΩúÊó•ÈúÄË¶ÅÂáÜÂ§á
                    let alertDate = pickupDate.subtract(1, 'day');
                    
                    // Â¶ÇÊûúÊèêË¥ßÊó•ÊúüÊòØÂë®‰∏Ä(1)ÔºåÂâç‰∏ÄÂ§©ÊòØÂë®Êó•ÔºåÂ∫îËØ•ÊèêÂâçÂà∞Âë®‰∫î(subtract 3 days from Mon)
                    // Â¶ÇÊûúÊèêË¥ßÊó•ÊúüÊòØÂë®Êó•(0)ÔºåÂâç‰∏ÄÂ§©ÊòØÂë®ÂÖ≠ÔºåÂ∫îËØ•ÊèêÂâçÂà∞Âë®‰∫î(subtract 2 days from Sun)
                    // Â¶ÇÊûúÊèêË¥ßÊó•ÊúüÊòØÂë®ÂÖ≠(6)ÔºåÂâç‰∏ÄÂ§©ÊòØÂë®‰∫îÔºåÂ∫îËØ•ÊèêÂâçÂà∞Âë®‰∫î(subtract 1 day from Sat)
                    
                    // ‰øÆÊ≠£ÈÄªËæëÔºöÊàë‰ª¨ÊÉ≥ÊâæÂà∞‚ÄúÂì™Â§©ÂºÄÂßãÊèêÈÜí‚Äù„ÄÇ
                    // Â¶ÇÊûúÊèêË¥ßÊòØÂë®‰∫åÔºåÂë®‰∏ÄÊèêÈÜí„ÄÇ
                    // Â¶ÇÊûúÊèêË¥ßÊòØÂë®‰∏ÄÔºå‰∏äÂë®‰∫îÊèêÈÜí„ÄÇ
                    // Â¶ÇÊûúÊèêË¥ßÊòØÂë®Êó•Ôºå‰∏äÂë®‰∫îÊèêÈÜí„ÄÇ
                    // Â¶ÇÊûúÊèêË¥ßÊòØÂë®ÂÖ≠Ôºå‰∏äÂë®‰∫îÊèêÈÜí„ÄÇ
                    
                    if (pickupDate.day() === 1) { // Mon
                        alertDate = pickupDate.subtract(3, 'day'); // Fri
                    } else if (pickupDate.day() === 0) { // Sun
                        alertDate = pickupDate.subtract(2, 'day'); // Fri
                    } else if (pickupDate.day() === 6) { // Sat
                        alertDate = pickupDate.subtract(1, 'day'); // Fri
                    }
                    
                    // Âè™Ë¶Å ‰ªäÂ§© >= ÊèêÈÜíÊó• ‰∏î ‰ªäÂ§© < ÊèêË¥ßÊó•ÔºåÂ∞±ÁÆó‚ÄúÂáÜÂ§áÊ¥æËΩ¶‚Äù
                    // Âè¶Â§ñÔºåÂ¶ÇÊûú‰ªäÂ§©Â∑≤ÁªèÊòØÊèêË¥ßÊó•‰∫ÜÔºå‰ΩÜËøòÊ≤°ÂèëË¥ßÔºàÂÅáËÆæËøòÊ≤°ËøáÔºâÔºå‰πüÂèØ‰ª•ÁÆóÔºü
                    // ËøôÈáåÁöÑÈÄªËæëÊòØÔºöDashboardÊòæÁ§∫‚ÄúÈúÄË¶ÅÂÖ≥Ê≥®ÁöÑÂçïÂ≠ê‚Äù„ÄÇ
                    // ËåÉÂõ¥ÔºöAlertDate <= Today < PickupDate
                    
                    if (today.isSame(alertDate, 'day') || (today.isAfter(alertDate) && today.isBefore(pickupDate))) {
                        pending.push({
                            ...order,
                            statusReason: today.isSame(alertDate, 'day') ? '‰ªäÊó•ÈúÄÂÆâÊéí' : 'ÈÄæÊúü/‰∏¥Ëøë'
                        });
                    }

                    // 2. ËøêËæì‰∏≠Âà§Êñ≠
                    // ÈÄªËæëÔºöÊèêË¥ßÊó•Êúü <= ‰ªäÂ§© <= ÈÄÅË¥ßÊó•Êúü
                    // Â¶ÇÊûúÊ≤°ÊúâÈÄÅË¥ßÊó•ÊúüÔºåÂÅáËÆæÊèêË¥ßÂΩìÂ§©Âç≥ËøêËæì‰∏≠
                    if (today.isSame(pickupDate, 'day') || (deliveryDate && today.isAfter(pickupDate) && today.isBefore(deliveryDate.add(1, 'day')))) {
                         transit.push(order);
                    }
                });

                // ÊåâÊó•ÊúüÊéíÂ∫è
                pending.sort((a, b) => dayjs(a.pickupDate).valueOf() - dayjs(b.pickupDate).valueOf());
                transit.sort((a, b) => dayjs(a.pickupDate).valueOf() - dayjs(b.pickupDate).valueOf());

                setPendingDispatch(pending);
                setInTransit(transit);
            };

            const cardStyle = {
                marginBottom: 24, 
                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                borderRadius: 8
            };

            const columns = [
                { title: 'Shipment ID', dataIndex: 'shipmentId', key: 'shipmentId' },
                { title: 'Ë∑ØÁ∫ø', dataIndex: 'routeName', key: 'routeName' },
                { 
                    title: 'ÊèêË¥ßÊó•Êúü', 
                    dataIndex: 'pickupDate', 
                    key: 'pickupDate',
                    render: t => <span style={{color: '#d97706', fontWeight: 'bold'}}>{dayjs(t).format('YYYY-MM-DD')}</span>
                },
                { title: 'ÊâøËøêËΩ¶Èòü', dataIndex: 'fleet', key: 'fleet' },
                {
                    title: 'Êìç‰Ωú',
                    key: 'action',
                    render: (_, record) => (
                        <Button type="link" size="small" onClick={() => onNavigate('5')}>Êü•ÁúãËØ¶ÊÉÖ</Button>
                    )
                }
            ];

            return (
                <div style={{ padding: '0 8px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 24 }}>
                        {/* ÂæÖÊ¥æËΩ¶/ÂáÜÂ§áÊ¥æËΩ¶ */}
                        <Card 
                            title={
                                <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                                    <span style={{fontSize: 20}}>üì¢</span>
                                    <span style={{fontSize: 18, fontWeight: 'bold', color: '#b45309'}}>ÂáÜÂ§áÊ¥æËΩ¶ ({pendingDispatch.length})</span>
                                </div>
                            } 
                            bordered={false} 
                            style={{...cardStyle, borderTop: '4px solid #f59e0b'}}
                            headStyle={{backgroundColor: '#fffbeb'}}
                        >
                            {pendingDispatch.length > 0 ? (
                                <Table 
                                    dataSource={pendingDispatch} 
                                    columns={columns} 
                                    rowKey="id" 
                                    pagination={false} 
                                    size="small"
                                />
                            ) : (
                                <Empty description="ÊöÇÊó†ÊÄ•ÈúÄÊ¥æËΩ¶ÁöÑËÆ¢Âçï" image={Empty.PRESENTED_IMAGE_SIMPLE} />
                            )}
                            <div style={{marginTop: 16, fontSize: 12, color: '#9ca3af'}}>
                                * Êô∫ËÉΩÊèêÈÜíÔºöÊ†πÊçÆÊèêË¥ßÊó•ÊúüÊèêÂâç1‰∏™Â∑•‰ΩúÊó•ÊèêÈÜíÔºàËá™Âä®Ë∑≥ËøáÂë®Êú´Ôºâ
                            </div>
                        </Card>

                        {/* ËøêËæì‰∏≠ */}
                        <Card 
                            title={
                                <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                                    <span style={{fontSize: 20}}>üöö</span>
                                    <span style={{fontSize: 18, fontWeight: 'bold', color: '#15803d'}}>ËøêËæì‰∏≠ ({inTransit.length})</span>
                                </div>
                            } 
                            bordered={false} 
                            style={{...cardStyle, borderTop: '4px solid #22c55e'}}
                            headStyle={{backgroundColor: '#f0fdf4'}}
                        >
                             {inTransit.length > 0 ? (
                                <Table 
                                    dataSource={inTransit} 
                                    columns={columns} 
                                    rowKey="id" 
                                    pagination={false} 
                                    size="small"
                                />
                            ) : (
                                <Empty description="ÊöÇÊó†ËøêËæì‰∏≠ÁöÑËÆ¢Âçï" image={Empty.PRESENTED_IMAGE_SIMPLE} />
                            )}
                             <div style={{marginTop: 16, fontSize: 12, color: '#9ca3af'}}>
                                * Áä∂ÊÄÅËØ¥ÊòéÔºöÂΩìÂâçÊó•ÊúüÂú®ÊèêË¥ßÊó•ÊúüÂíåÈÄÅË¥ßÊó•Êúü‰πãÈó¥
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- ‰∏ªÂ∫îÁî®ÂÖ•Âè£ ---
        const App = () => {
            const [addresses, setAddresses] = useState([]);
            const [routes, setRoutes] = useState([]);
            const [activeTab, setActiveTab] = useState('0');
            const [editingRoute, setEditingRoute] = useState(null);
            const [editingOrder, setEditingOrder] = useState(null);

            useEffect(() => {
                setAddresses(getAddresses());
                setRoutes(getRoutes());
                // ÁßªÈô§ loading
                const loading = document.getElementById('loading-text');
                if (loading) loading.style.display = 'none';
            }, []);

            const handleEditOrder = (order) => {
                setEditingOrder(order);
                setActiveTab('4');
                message.info('Â∑≤ËΩΩÂÖ•ËÆ¢Âçï‰ø°ÊÅØÔºå‰øÆÊîπÂêéÁÇπÂáª‚Äú‰øùÂ≠ò‰øÆÊîπ‚ÄùÂç≥ÂèØÊõ¥Êñ∞ËÆ∞ÂΩï');
            };

            const handleOrderComplete = () => {
                setEditingOrder(null);
                setActiveTab('5'); 
            };

            const handleCancelEdit = () => {
                setEditingOrder(null);
                message.info('Â∑≤ÂèñÊ∂àÁºñËæë');
            };

            const handleBackup = () => {
                const data = {
                    addresses: getAddresses(),
                    routes: getRoutes(),
                    orders: getOrders(),
                    version: '1.0',
                    backupDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Ê¥æËΩ¶Á≥ªÁªüÂ§á‰ªΩ-${dayjs().format('YYYY-MM-DD')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                message.success('Â§á‰ªΩÊñá‰ª∂Â∑≤‰∏ãËΩΩ');
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.addresses) saveAddresses(data.addresses);
                        if (data.routes) saveRoutes(data.routes);
                        if (data.orders) saveOrders(data.orders);
                        
                        message.success('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºåÈ°µÈù¢Âç≥Â∞ÜÂà∑Êñ∞');
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (error) {
                        message.error('ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºèÈîôËØØ');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const items = [
                {
                    key: '0',
                    label: <span style={{fontSize: 16}}>üìä ÊÄªËßà</span>,
                    children: <Overview onNavigate={setActiveTab} />,
                },
                {
                    key: '4',
                    label: <span style={{fontSize: 16}}>üìÑ Ê¥æËΩ¶ÂçïÁîüÊàê</span>,
                    children: <DispatchGenerator 
                        routes={routes} 
                        addresses={addresses} 
                        editingOrder={editingOrder}
                        onOrderComplete={handleOrderComplete}
                        onCancelEdit={handleCancelEdit}
                    />,
                },
                {
                    key: '5',
                    label: <span style={{fontSize: 16}}>üóìÔ∏è ËÆ¢ÂçïËÆ∞ÂΩï</span>,
                    children: <OrderManagement 
                        addresses={addresses}
                        onEditOrder={handleEditOrder}
                    />,
                },
                {
                    key: '2',
                    label: <span style={{fontSize: 16}}>üöö DIY Ë∑ØÁ∫øËßÑÂàí</span>,
                    children: <RoutePlanning 
                        addresses={addresses} 
                        routes={routes} 
                        setRoutes={setRoutes} 
                        setActiveTab={setActiveTab} 
                        editingRoute={editingRoute}
                        setEditingRoute={setEditingRoute}
                    />,
                },
                {
                    key: '3',
                    label: <span style={{fontSize: 16}}>üìã Á∫øË∑ØÁÆ°ÁêÜ</span>,
                    children: <RouteManagement 
                        routes={routes} 
                        addresses={addresses} 
                        setRoutes={setRoutes} 
                        setActiveTab={setActiveTab}
                        setEditingRoute={setEditingRoute}
                    />,
                },
                {
                    key: '1',
                    label: <span style={{fontSize: 16}}>üè¢ Âú∞ÂùÄÂ∫ìÁÆ°ÁêÜ</span>,
                    children: <AddressLibrary addresses={addresses} setAddresses={setAddresses} />,
                },
            ];

            return (
                <ConfigProvider
                    theme={{
                        token: {
                            colorPrimary: '#1677ff',
                            borderRadius: 8,
                            colorBgContainer: '#ffffff',
                        },
                    }}
                >
                    <div className="container">
                        <div style={{ position: 'relative', marginBottom: 40, textAlign: 'center' }}>
                            <Title level={2} style={{ margin: 0, color: '#1f2937', display: 'inline-block' }}>
                                <span style={{fontWeight: 800, fontSize: '34px'}}>
                                    üöõ Ê¥æËΩ¶Ë°®ÁÆ°ÁêÜÁ≥ªÁªü
                                </span>
                            </Title>
                            <div style={{ position: 'absolute', right: 0, top: '50%', transform: 'translateY(-50%)' }}>
                                <Space>
                                    <Button onClick={handleBackup}>üì§ Â§á‰ªΩÊï∞ÊçÆ</Button>
                                    <Button onClick={() => document.getElementById('import-input').click()}>üì• ÊÅ¢Â§çÊï∞ÊçÆ</Button>
                                </Space>
                            </div>
                            <input 
                                type="file" 
                                id="import-input" 
                                style={{display: 'none'}} 
                                accept=".json" 
                                onChange={handleImport} 
                            />
                        </div>
                        <Tabs 
                            defaultActiveKey="0" 
                            activeKey={activeTab} 
                            onChange={setActiveTab} 
                            items={items} 
                            type="card"
                            size="large"
                            tabBarStyle={{marginBottom: 32}}
                        />
                    </div>
                </ConfigProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>